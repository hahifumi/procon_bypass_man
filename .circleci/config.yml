version: 2.1
orbs:
  ruby: circleci/ruby@0.1.2 

executors:
  ruby:
    parameters:
      tag:
        type: string
        default: "latest"
    docker:
      - image: ruby:<< parameters.tag >>
    environment:
      BUNDLE_PATH: vendor/bundle
      BUNDLE_JOBS: 4
    working_directory: ~/app

jobs:
  lint:
    parameters:
      ruby-version:
        type: string
    executor:
      name: ruby
      tag: << parameters.ruby-version >>
    steps:
      - checkout
      - run: ruby --version
      - run: bundle --version
      - run: gem --version
      - run: gem install bundler
      - run: bundle install --jobs 4
      - run: bundle exec rubocop
  type_check:
    parameters:
      ruby-version:
        type: string
    executor:
      name: ruby
      tag: << parameters.ruby-version >>
    steps:
      - checkout
      - run: ruby --version
      - run: bundle --version
      - run: gem --version
      - run: gem install bundler
      - run: bundle install --jobs 4
      - run: bundle exec steep check
  rspec:
    parameters:
      ruby-version:
        type: string
    executor:
      name: ruby
      tag: << parameters.ruby-version >>
    steps:
      - checkout
      - run: ruby --version
      - run: bundle --version
      - run: gem --version
      - run: gem install bundler
      - run: bundle install --jobs 4
      - run: bundle exec rspec

build_jobs: &build_jobs
  - lint:
      matrix:
        parameters:
          ruby-version:
            - "2.7"
            - "3.0.1"
            - "3.0.2"
            - "3.1.0"
  - type_check:
      matrix:
        parameters:
          ruby-version:
            - "2.7"
            # - "3.0.1" # たまにSEGVするので
            - "3.0.2"
            - "3.1.0"
  - rspec:
      matrix:
        parameters:
          ruby-version:
            - "2.7"
            - "3.0.1"
            - "3.0.2"
            - "3.1.0"
workflows:
  version: 2
  build:
    jobs: *build_jobs
